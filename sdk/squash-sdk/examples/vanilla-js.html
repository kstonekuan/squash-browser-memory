<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Squash SDK - Vanilla JS Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #1a1a1a;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .chat-container {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      min-height: 300px;
      margin-bottom: 20px;
      background: #fafafa;
    }
    .input-group {
      display: flex;
      gap: 10px;
    }
    input {
      flex: 1;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      padding: 12px 24px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #1557b0;
    }
    .message {
      margin-bottom: 16px;
      padding: 12px;
      background: white;
      border-radius: 6px;
    }
    .message.user {
      background: #e3f2fd;
      text-align: right;
    }
    .message.ai {
      background: white;
      border: 1px solid #e0e0e0;
    }
    .context-info {
      background: #f0f7ff;
      border: 1px solid #1a73e8;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .status.success {
      background: #e6f4ea;
      color: #1e8e3e;
    }
    .status.error {
      background: #fce8e6;
      color: #d33b29;
    }
    .status.warning {
      background: #fef7e0;
      color: #f9ab00;
    }
  </style>
  <!-- Include Squash SDK from CDN -->
  <script src="https://unpkg.com/squash-sdk@latest/dist/squash-sdk.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>AI Chat with Squash Context</h1>
    <p class="subtitle">This demo shows how Squash SDK enhances AI interactions with browsing context</p>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div id="context-info" class="context-info" style="display: none;">
      <strong>Context Available!</strong>
      <div id="context-summary"></div>
    </div>
    
    <div id="chat" class="chat-container">
      <div class="message ai">
        Hello! I'm an AI assistant enhanced with your browsing context. Ask me anything!
      </div>
    </div>
    
    <div class="input-group">
      <input 
        type="text" 
        id="user-input" 
        placeholder="Ask me anything..."
        autofocus
      >
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    let context = null;
    
    // Initialize Squash SDK when page loads
    async function initializeSquash() {
      try {
        showStatus('Initializing Squash SDK...', 'warning');
        
        // Initialize SDK
        const initResult = await squash.init({
          appName: 'AI Chat Demo',
          appId: 'ai-chat-demo',
          installPrompt: true,
          mockMode: false // Set to true for testing without extension
        });
        
        console.log('Init result:', initResult);
        
        if (!initResult.extensionInstalled) {
          showStatus('Squash extension not installed. Install it for enhanced AI responses!', 'warning');
          return;
        }
        
        if (!initResult.permissionGranted) {
          showStatus('Permission denied. The app will work without context enhancement.', 'warning');
          return;
        }
        
        // Get context
        const contextResult = await squash.getContext({
          timeRange: '7d',
          maxTokens: 1000
        });
        
        console.log('Context result:', contextResult);
        
        if (contextResult.status === 'success') {
          context = contextResult.context;
          showStatus('Context loaded successfully!', 'success');
          showContextInfo(context);
        } else {
          showStatus(`Failed to load context: ${contextResult.status}`, 'error');
        }
        
      } catch (error) {
        console.error('Initialization error:', error);
        showStatus('Failed to initialize: ' + error.message, 'error');
      }
    }
    
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
    }
    
    function showContextInfo(ctx) {
      const infoEl = document.getElementById('context-info');
      const summaryEl = document.getElementById('context-summary');
      
      summaryEl.innerHTML = `
        <p>${ctx.summary}</p>
        <p><small>Topics: ${ctx.topics.map(t => t.topic).join(', ')}</small></p>
      `;
      
      infoEl.style.display = 'block';
    }
    
    function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message
      addMessage(message, 'user');
      
      // Simulate AI response with context
      setTimeout(() => {
        const response = generateAIResponse(message);
        addMessage(response, 'ai');
      }, 500);
      
      input.value = '';
    }
    
    function addMessage(text, sender) {
      const chat = document.getElementById('chat');
      const messageEl = document.createElement('div');
      messageEl.className = `message ${sender}`;
      messageEl.textContent = text;
      chat.appendChild(messageEl);
      chat.scrollTop = chat.scrollHeight;
    }
    
    function generateAIResponse(userMessage) {
      if (context) {
        // Use context to provide more relevant response
        const relevantTopic = context.topics.find(t => 
          userMessage.toLowerCase().includes(t.topic.toLowerCase())
        );
        
        if (relevantTopic) {
          return `Based on your interest in ${relevantTopic.topic}, I can provide specialized help. ${context.summary} What specific aspect would you like to explore?`;
        }
        
        return `I understand you've been ${context.patterns[0]?.description || 'working on various projects'}. How can I help with your current task?`;
      }
      
      // Fallback response without context
      return "I'd be happy to help! Could you provide more details about what you're looking for?";
    }
    
    // Handle Enter key in input
    document.getElementById('user-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Initialize on page load
    window.addEventListener('load', initializeSquash);
  </script>
</body>
</html>